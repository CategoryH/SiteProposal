# SiteProposal

### 注册流程
填邮箱，密码，确认密码，**邀请码**（详见下文），然后填邮箱里收到的验证码，然后注册。

昵称可以改，但全站唯一，不带头像。

#### 公私钥保证溯源
用户在网站注册后，可以在网站生成一对公私钥。公钥对所有人可见，私钥只有用户本人和网站可见。高级玩家可以**自己生成公私钥对**，向网站提交自己的公钥，自己保管私钥（这种情形私钥不可找回）。

#### 登录
1. 用邮箱和密码登录
2. 用密钥签名登录

#### 密码找回和修改
1. 用邮箱验证
2. 用密钥验证

### 用户的属性

#### public:
* 昵称（全站唯一，但可以修改）
* 公钥（固定，不可修改）
* 一句话简介
* 角色（详见下文）

#### private:
* 私钥（可能不存在）
* 邮箱
* 密码
* 投票权重：`vote_powers` 是一个数值向量，每个版面一个数值，决定了用户在每个版的投票权重，默认值在每个版都是 `1.0`. （调整方式见下文）
  
TODO: 投票权重要不要公开？
TODO: 关注问题、版面、收藏夹是公开还是私密？

### 用户角色
用户有三种角色，是递进关系
1. 普通用户
2. 版面管理员
3. 全站管理员

#### 通用操作：
登录/注销/找回密码/修改密码

#### 专有操作
**普通用户**：以版面 `/r/HelloWorld` 为例

1. 提问/编辑提问（用户把问题提交给版面如 `/r/HelloWorld`）（提问两天内能编辑，两天之后只能补充）
2. 回答/编辑回答（用户把回答提交给问题如 `/question/X`，生成回答 `/question/X/answer/Y`）
3. 评论问题，回复评论
3. 赞/踩问题（赞：`upvote += user.vote_powers("HelloWorld")`, 踩: `downvote += user.vote_powers("HelloWorld")`, 注意两者是分开计数的，每个问题计算 `vote = (upvote, downvote)`.）
4. 赞/踩答案（同上）
4. 赞/踩评论（同上）
5. 问题/答案提交的同时默认提交者给自己 upvote（用权重算）
5. 关注问题（+取消）
6. 关注版面（+取消）
7. 关注收藏夹（+取消）
8. 编辑个人资料（TODO: 个人资料放哪些内容？一句话简介？）

投票权重比较高的用户（TODO: 写清楚）获得关闭问题的权力。
    
**版面管理员**：

1. 给优质答案（详见下文）的作者发放邀请码
2. TODO: 版面管理员看到的信息要不要比普通用户多一些，多哪些？

**管理员**：

1. 创建版面（TODO: 创建版面的规则。“子版面可以由某个版面的高质量用户（标准待定）提出，提出后，获得全站级运营的通过，成为”试验“版面，维持一段时间(1~3个月)以后，全站级运营根据版面质量决定是否转正，如果不转正，那么试验版面下的所有内容都归入原父版面。”）
2. 任免版面管理员

### 邀请码
邀请码是注册的必需品，邀请码由系统生成，发放渠道：
1. 版面管理员发给高质量答案的作者（每个高质量回答两个邀请码，每个人可用的邀请码不能超过五个）。
2. 初期，管理员定向邀请。

### Confidence Score

任何内容，有了一定量的 `up` 和 `down` 投票，可以计算其 `confidence score` ([Wikipedia](https://en.wikipedia.org/wiki/Binomial_proportion_confidence_interval)), 即对其真实分数的有 `95%` 信心的估算的下界。下面会用到不少，在此介绍。

计算方法如下：

    def confidence(up, down):
        n = up + down
        if (n == 0): 
            return 0.0
        p = up / n
        z = 1.96
        y = z * z / n
        return (p + y/2 - z * math.sqrt((p * (1-p) + y/4)/n))/(1 + y)
        
写死数字的话如下

    def confidence(up, down):
        if (up == 0):
            return 0.0
        else:
            n = up + down        
            return (up + 1.9208 - 1.96 * math.sqrt(up * down / n + 0.9604))/(n + 3.8416)

### 版面
定义：版面是一个固定主题的讨论场所，是固定主题下问题和答案的总体。hello 话题的页面记作 `site.com/r/hello`


#### 版面分栏：优质内容/问题列表/最新回答/精华

1. 版面首页: `r/hello#popular`
2. 问题列表: `r/hellp#questions`
3. 最新回答: `r/hello#newest`
4. 精华内容: `r/hello#best`

**版面首页**，预览一系列答案，根据热度 `hotness` 排序。其中热度是质量和时间的函数：

     hotness = f(quality, date)
 
目标是做到优质内容分数高，新内容优先于老内容。其中 `quality` 可以这样定义（参数待定）

      vdiff = upvote - downvote // 每个 vote 带来的变化 ≈ 1
       sign = sgn(vdiff)
    quality = sign * log(1 + abs(vdiff/10)) * 10 // 这是与时间无关的 quality, 
              // 这个 quality 的要点在于，vdiff 不大的时候基本上跟 vdiff 是线性的，
              // 较大的时候每次 vdiff 增加带来的 quality 增量较小
              // 里面的 10 是可以调整的参数
    
而 `date` 是（答案的）诞生时间，定义为发文时刻的 `epochtime() - Constant`, 单位是秒。

如果定义

    hotness = quality + k * date
    
则可实现优质内容分数高，新内容优先于老内容，其中 `k` 是一个正的参数。（例如定义 `k = 1/(6 * 60 * 60) = 1/21600`, 相当于是说每 6 小时热度减一，因为六小时之后发的内容 `k * date` 比六小时前的多 1.）

（更自然的想法是用发帖至今的时间，帖子的 ”年龄“ 来计算 `hotness`, 但年龄是个一直变化的东西，`date` 是一个固定值，发文的那一刻就可计算，且后来者的 `date` 一定大于先来的，这是 reddit 的办法。）

**问题列表**（时间和 `votes` 的函数，`downvote >> upvote` 的关闭）

关闭问题的逻辑：`downvote-confidence > 0.5` 的问题，启动关闭投票。这里

    downvote-confidence(up, down) = confidence(down, up)
    
简单说就是如果 `up` 为 `0`, `down` 超过 `4`, 或者 `up = 1`, `down` 超过 `7`, `(2,9)`, `(3, 11)`…… 
（TODO: 谁可以参与这个投票？）

**最新回答**（时间逆序，**仅**按时间排序）

**精华内容**（与时间无关的，讨论沉淀下来的优质内容）
用 `confidence score` 排序。

### 问题页面
信息结构如下

    问题
    ├────── 评论x
    │       ├── 评论x的回复
    │       └── 评论x的回复
    ├────── 评论y
    │       ├── 评论y的回复
    │       └── 评论y的回复
    │       
    ├── 答案1
    │   ├── 评论a
    │   │   ├── 评论a的回复
    │   │   └── 评论a的回复
    │   ├── 评论b
    │   │   ├── 评论b的回复
    │   │   ├── 评论b的回复
    │   │   └── 评论b的回复
    ├── 答案2
    │   ├── 评论c
    │   │   ├── 评论c的回复
    │   │   └── 评论c的回复
    │   ├── 评论d
    │   │   ├── 评论d的回复
    │   │   └── 评论d的回复
    └── 答案3
        ├── 评论e
        │   ├── 评论e的回复
        │   └── 评论e的回复
        └── 评论f
            ├── 评论f的回复
            └── 评论f的回复

### 投票权重
* 是一个数值向量，每个版面一个数值，决定了用户在每个版的投票权重
* 默认值在每个版都是 `1.0`. 
* 最低 `0.1`, 最高 `10.0`.
* TODO: 投票权重的增减
* TODO: 对于违反版面规则的用户，可以用降低权重处罚？
* TODO: 高权重用户的权重是否应该适当随时间递减？

### 优质答案
临时定义：版面上 `confidence score > 0.85` 的内容。

或者也可以定义成版面上 `confidence score` 的前 `15%`? 这个要跑起来才知道。

### 全站首页

需不需要全站首页？如何定义全站首页的排序？

用户订阅了不同的版面、问题和收藏夹，起码用户登录后的时间线要给这些地方出现的新内容一个排序。（TODO）

### 评论排序
用 `confidence score`, 从 `up` 和 `down` 计算出来（`up` 和 `down` 分别是评论得到的票数）。

`score` 相同的情形，随机排序，但尊重评论的从属关系。

### 杂项
MathJax + XyJax 设置参见 https://stacks.math.columbia.edu/tag/0780 的 source code.

### Idea
vote 越多，每个 vote 的贡献越小？


